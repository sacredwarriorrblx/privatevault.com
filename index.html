<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivateVault | Family Heirlooms</title>
    <style>
        :root { --primary: #2d3748; --accent: #4c51bf; --bg: #f8fafc; --admin: #805ad5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .section { display: none; }
        .active { display: block; }
        input, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #cbd5e0; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.admin-btn { background: var(--admin); }
        .note-card { background: #f1f5f9; padding: 15px; margin: 10px 0; border-left: 5px solid var(--accent); position: relative; }
        .error { color: #e53e3e; font-weight: bold; text-align: center; }
        .hidden-code { background: #2d3748; color: #2d3748; padding: 5px; cursor: pointer; border-radius: 4px; }
        .hidden-code:hover { color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title">PrivateVault</h1>
    <div id="error-msg" class="error"></div>

    <div id="login-sec" class="section active">
        <h2>Family Login</h2>
        <input type="text" id="login-user" placeholder="Username">
        <input type="text" id="login-secret" placeholder="Your Personal Secret">
        <button onclick="handleLogin()">Login</button>
        <hr>
        <button style="background:#edf2f7; color: #2d3748;" onclick="showSection('reg-sec')">Register New Member</button>
    </div>

    <div id="reg-sec" class="section">
        <h2>Join the Family</h2>
        <input type="text" id="reg-user" placeholder="Create Username">
        <input type="text" id="reg-secret" placeholder="Personal Secret (This is your access key)">
        <button onclick="handleRegister()">Create Account</button>
        <button style="background:none; color:grey" onclick="showSection('login-sec')">Back to Login</button>
    </div>

    <div id="verify-sec" class="section">
        <h2>Enter Family Code</h2>
        <p>A 20-minute security code is required to enter the vault.</p>
        <input type="text" id="verify-code-input" placeholder="Paste the code from Admin...">
        <button onclick="confirmFamilyCode()">Verify & Enter</button>
    </div>

    <div id="vault-sec" class="section">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2 id="welcome-msg">Your Vault</h2>
            <button onclick="logout()" style="width:auto; padding: 5px 15px;">Logout</button>
        </div>
        
        <div id="admin-controls" style="display:none; border: 2px solid var(--admin); padding: 15px; margin-bottom: 20px;">
            <h3 style="color:var(--admin); margin-top:0;">Admin Security Panel</h3>
            <p>Current Family Code: <span class="hidden-code" id="admin-code-display" title="Click to reveal">HIDDEN</span></p>
            <p><small>Code expires in: <span id="timer"></span></small></p>
            <button class="admin-btn" onclick="generateNewCode()">Generate New Complex Code</button>
        </div>

        <div id="note-editor" style="background: #edf2f7; padding: 15px; border-radius: 8px;">
            <h3>Create a Note/Record</h3>
            <input type="text" id="note-title" placeholder="Title (e.g. My Website)">
            <textarea id="note-content" placeholder="Content or Secret Details..."></textarea>
            <button onclick="saveNote()">Add to Vault</button>
        </div>

        <div id="notes-list"></div>
    </div>
</div>

<script>
    let users = JSON.parse(localStorage.getItem('pv_users')) || {};
    let system = JSON.parse(localStorage.getItem('pv_system')) || { currentCode: "", expiry: 0, usedCodes: [] };
    let currentUser = null;

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- LOGIC: CODE GENERATION ---
    function generateNewCode() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
        let newCode = "";
        do {
            newCode = "";
            for (let i = 0; i < 12; i++) newCode += chars.charAt(Math.floor(Math.random() * chars.length));
        } while (system.usedCodes.includes(newCode));

        system.currentCode = newCode;
        system.expiry = Date.now() + (20 * 60 * 1000);
        system.usedCodes.push(newCode);
        saveSystem();
        renderAdmin();
    }

    // --- LOGIC: AUTHENTICATION ---
    function handleRegister() {
        const u = document.getElementById('reg-user').value;
        const s = document.getElementById('reg-secret').value;
        if(!u || !s) return alert("Fill all fields");
        
        const isAdmin = Object.keys(users).length === 0; // First user is Admin
        users[u] = { secret: s, isAdmin: isAdmin, notes: [] };
        localStorage.setItem('pv_users', JSON.stringify(users));
        alert(isAdmin ? "Admin account created!" : "Account created! Ask Admin for family code.");
        showSection('login-sec');
    }

    function handleLogin() {
        const u = document.getElementById('login-user').value;
        const s = document.getElementById('login-secret').value;
        
        if (users[u] && users[u].secret === s) {
            currentUser = u;
            if (users[u].isAdmin) {
                if(!system.currentCode) generateNewCode();
                enterVault();
            } else {
                showSection('verify-sec');
            }
        } else {
            alert("Invalid credentials.");
        }
    }

    function confirmFamilyCode() {
        const input = document.getElementById('verify-code-input').value;
        if (Date.now() > system.expiry) {
            alert("Code has expired! Ask Admin for a new one.");
            generateNewCode();
            return;
        }
        if (input === system.currentCode) {
            enterVault();
        } else {
            alert("Incorrect Family Code.");
        }
    }

    // --- VAULT MANAGEMENT ---
    function enterVault() {
        showSection('vault-sec');
        document.getElementById('welcome-msg').innerText = `Hello, ${currentUser}`;
        if (users[currentUser].isAdmin) {
            document.getElementById('admin-controls').style.display = 'block';
            renderAdmin();
        }
        renderNotes();
    }

    function saveNote() {
        const title = document.getElementById('note-title').value;
        const content = document.getElementById('note-content').value;
        users[currentUser].notes.push({ title, content, id: Date.now() });
        localStorage.setItem('pv_users', JSON.stringify(users));
        renderNotes();
        document.getElementById('note-title').value = '';
        document.getElementById('note-content').value = '';
    }

    function deleteNote(id) {
        users[currentUser].notes = users[currentUser].notes.filter(n => n.id !== id);
        localStorage.setItem('pv_users', JSON.stringify(users));
        renderNotes();
    }

    function renderNotes() {
        const list = document.getElementById('notes-list');
        list.innerHTML = '<h3>Your Stored Secrets</h3>';
        users[currentUser].notes.forEach(n => {
            list.innerHTML += `
                <div class="note-card">
                    <strong>${n.title}</strong><br>${n.content}
                    <button onclick="deleteNote(${n.id})" style="width:auto; padding:2px 10px; background:red; margin-top:10px;">Delete</button>
                </div>`;
        });
    }

    function renderAdmin() {
        document.getElementById('admin-code-display').innerText = system.currentCode;
    }

    function saveSystem() { localStorage.setItem('pv_system', JSON.stringify(system)); }
    function logout() { location.reload(); }

    // Timer Update
    setInterval(() => {
        if(system.expiry > 0) {
            const rem = Math.max(0, system.expiry - Date.now());
            const m = Math.floor(rem/60000);
            const s = Math.floor((rem%60000)/1000);
            document.getElementById('timer').innerText = `${m}m ${s}s`;
            if(rem === 0 && system.currentCode !== "") {
                system.currentCode = "[EXPIRED]";
                saveSystem();
            }
        }
    }, 1000);

</script>
</body>
</html>
