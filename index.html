<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivateVault</title>
    <style>
        :root { --primary: #1a202c; --accent: #3182ce; --bg: #f7fafc; --admin: #805ad5; --danger: #e53e3e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { display: none; }
        .active { display: block; }
        input, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #cbd5e0; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.secondary { background: #e2e8f0; color: #1a202c; }
        .admin-area { border: 2px solid var(--admin); padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #faf5ff; }
        .note-card { background: #edf2f7; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid var(--accent); }
        .secret-box { background: #fff5f5; padding: 15px; border: 1px dashed var(--danger); border-radius: 8px; margin: 15px 0; }
        .debug-panel { margin-top: 20px; font-size: 10px; color: #a0aec0; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>PrivateVault</h1>

    <div id="login-sec" class="section active">
        <h2>Login</h2>
        <input type="text" id="login-user" placeholder="Username">
        <input type="password" id="login-pass" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <button class="secondary" onclick="showSection('reg-sec')">Create New Account</button>
    </div>

    <div id="reg-sec" class="section">
        <h2>Register</h2>
        <input type="text" id="reg-user" placeholder="Username">
        <input type="password" id="reg-pass" placeholder="Password">
        <input type="text" id="reg-secret" placeholder="Personal Secret (Readable)">
        <button onclick="handleRegister()">Create Account</button>
        <button class="secondary" onclick="showSection('login-sec')">Back</button>
    </div>

    <div id="verify-sec" class="section">
        <h2>Family Access Code</h2>
        <input type="text" id="verify-code-input" placeholder="Enter y52S30%2D1)r style code">
        <button onclick="confirmFamilyCode()">Enter Vault</button>
    </div>

    <div id="vault-sec" class="section">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2 id="welcome-msg">Vault</h2>
            <button onclick="logout()" style="width:auto; background:var(--danger)">Logout</button>
        </div>

        <div id="admin-panel" style="display:none" class="admin-area">
            <h3 style="color:var(--admin); margin-top:0">Admin Panel</h3>
            <p>Rotating Code: <code id="current-code-text" style="background:#eee;padding:2px"></code></p>
            <button onclick="generateComplexCode()" style="background:var(--admin)">New Code</button>
            <hr>
            <h4>Family Secrets (Passwords are HIDDEN)</h4>
            <div id="admin-user-list"></div>
        </div>

        <div class="secret-box">
            <h3>My Personal Secret</h3>
            <p id="my-stored-secret" style="font-weight:bold"></p>
        </div>

        <div id="notes-area">
            <h3>My Notes</h3>
            <input type="text" id="note-title" placeholder="Title">
            <textarea id="note-content" placeholder="Content..."></textarea>
            <button onclick="addNote()">Save Note</button>
            <div id="my-notes-list"></div>
        </div>
    </div>

    <div class="debug-panel">
        <strong>System Status:</strong> <span id="debug-info">No users found.</span>
        <button onclick="resetSystem()" style="width:auto; padding:2px 5px; font-size:9px; background:#cbd5e0; color:black;">Full System Reset</button>
    </div>
</div>

<script>
    let users = JSON.parse(localStorage.getItem('pv_users')) || {};
    let sys = JSON.parse(localStorage.getItem('pv_sys')) || { code: "", expiry: 0 };
    let currentUser = localStorage.getItem('pv_session_user');
    let hasVerifiedCode = sessionStorage.getItem('pv_verified') === 'true';

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function handleRegister() {
        const u = document.getElementById('reg-user').value.trim();
        const p = document.getElementById('reg-pass').value;
        const s = document.getElementById('reg-secret').value;
        if(!u || !p || !s) return alert("All fields required");
        
        const isAdmin = Object.keys(users).length === 0;
        users[u] = { password: p, personalSecret: s, isAdmin, notes: [] };
        localStorage.setItem('pv_users', JSON.stringify(users));
        updateDebug();
        alert("Account Created!");
        showSection('login-sec');
    }

    function handleLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value;

        if(!users[u]) {
            alert("Error: User '" + u + "' does not exist in this browser's memory.");
            return;
        }

        if(users[u].password === p) {
            currentUser = u;
            localStorage.setItem('pv_session_user', u);
            if(users[u].isAdmin) {
                if(!sys.code) generateComplexCode();
                openVault();
            } else {
                showSection('verify-sec');
            }
        } else {
            alert("Wrong password. Tip: Check Caps Lock.");
        }
    }

    function confirmFamilyCode() {
        if(document.getElementById('verify-code-input').value === sys.code) {
            hasVerifiedCode = true;
            sessionStorage.setItem('pv_verified', 'true');
            openVault();
        } else { alert("Wrong code."); }
    }

    function openVault() {
        showSection('vault-sec');
        document.getElementById('welcome-msg').innerText = "Hello, " + currentUser;
        document.getElementById('my-stored-secret').innerText = users[currentUser].personalSecret;
        if(users[currentUser].isAdmin) {
            document.getElementById('admin-panel').style.display = 'block';
            renderAdmin();
        }
        renderNotes();
    }

    function generateComplexCode() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
        let code = "";
        for (let i = 0; i < 12; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
        sys.code = code;
        localStorage.setItem('pv_sys', JSON.stringify(sys));
        renderAdmin();
    }

    function renderAdmin() {
        document.getElementById('current-code-text').innerText = sys.code;
        const list = document.getElementById('admin-user-list');
        list.innerHTML = "";
        Object.keys(users).forEach(u => {
            // ADMIN CANNOT SEE PASSWORDS, ONLY SECRETS
            list.innerHTML += `<p>Member: <b>${u}</b> | Secret: <i>${users[u].personalSecret}</i></p>`;
        });
    }

    function addNote() {
        users[currentUser].notes.push({t: document.getElementById('note-title').value, c: document.getElementById('note-content').value});
        localStorage.setItem('pv_users', JSON.stringify(users));
        renderNotes();
    }

    function renderNotes() {
        const div = document.getElementById('my-notes-list');
        div.innerHTML = "";
        users[currentUser].notes.forEach(n => {
            div.innerHTML += `<div class="note-card"><b>${n.t}</b><p>${n.c}</p></div>`;
        });
    }

    function logout() {
        localStorage.removeItem('pv_session_user');
        sessionStorage.removeItem('pv_verified');
        location.reload();
    }

    function resetSystem() {
        if(confirm("Wipe all accounts and start fresh?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function updateDebug() {
        const count = Object.keys(users).length;
        document.getElementById('debug-info').innerText = count + " accounts stored in this browser.";
    }

    updateDebug();
    if(currentUser) openVault();
</script>
</body>
</html>
