<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PrivateVault</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Segoe UI,sans-serif;background:#f7fafc;padding:20px}
.container{max-width:800px;margin:auto;background:#fff;padding:30px;border-radius:12px}
.section{display:none}
.active{display:block}
input,textarea,button{width:100%;padding:10px;margin:6px 0}
button{background:#3182ce;color:#fff;border:none;font-weight:bold}
.secondary{background:#e2e8f0;color:#000}
.danger{background:#e53e3e}
.admin-area{border:2px solid #805ad5;padding:10px;margin:10px 0}
.note-card{background:#edf2f7;padding:10px;margin:8px 0}
.captcha-box{background:#e2e8f0;padding:8px;font-weight:bold}
</style>
</head>

<body>
<div class="container">
<h1>PrivateVault</h1>

<div id="login-sec" class="section active">
<h2>Login</h2>
<input id="loginUser" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<div class="captcha-box" id="loginCaptchaText"></div>
<input id="loginCaptcha" placeholder="Captcha answer">
<button onclick="handleLogin()">Login</button>
<button class="secondary" onclick="showSection('reg-sec')">Register</button>
</div>

<div id="reg-sec" class="section">
<h2>Register</h2>
<input id="regUser" placeholder="Username">
<input id="regPass" type="password" placeholder="Password">
<input id="regSecret" placeholder="Personal Secret">
<div class="captcha-box" id="regCaptchaText"></div>
<input id="regCaptcha" placeholder="Captcha answer">
<button onclick="handleRegister()">Create</button>
<button class="secondary" onclick="showSection('login-sec')">Back</button>
</div>

<div id="verify-sec" class="section">
<h2>Family Code</h2>
<input id="verifyCode">
<button onclick="confirmFamilyCode()">Verify</button>
</div>

<div id="vault-sec" class="section">
<h2 id="welcome"></h2>
<button class="danger" onclick="logout()">Logout</button>

<div id="adminPanel" class="admin-area" style="display:none">
<p>Code: <code id="familyCode"></code></p>
<button onclick="generateCode()">New Code</button>
<div id="userList"></div>
</div>

<p><b>My Secret:</b> <span id="mySecret"></span></p>

<input id="noteTitle" placeholder="Note title">
<textarea id="noteContent" placeholder="Note"></textarea>
<button onclick="addNote()">Add</button>
<div id="notes"></div>
</div>
</div>

<script>
let users = JSON.parse(localStorage.getItem("pv_users")) || {};
let sys = JSON.parse(localStorage.getItem("pv_sys")) || {code:""};
let currentUser = localStorage.getItem("pv_user");

/* CAPTCHA */
let loginCap={}, regCap={};
function newCaptcha(el,obj){
    let a=Math.floor(Math.random()*10)+1;
    let b=Math.floor(Math.random()*10)+1;
    obj.ans=a+b;
    document.getElementById(el).innerText=`What is ${a}+${b}?`;
}
newCaptcha("loginCaptchaText",loginCap);
newCaptcha("regCaptchaText",regCap);

function save(){
    localStorage.setItem("pv_users",JSON.stringify(users));
    localStorage.setItem("pv_sys",JSON.stringify(sys));
}

function showSection(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

function handleRegister(){
    if(+document.getElementById("regCaptcha").value!==regCap.ans)
        return alert("Captcha wrong");

    let u=regUser.value.trim();
    let p=regPass.value;
    let s=regSecret.value;
    if(!u||!p||!s) return alert("Fill all fields");
    if(users[u]) return alert("User exists");

    let isAdmin=!Object.values(users).some(x=>x.isAdmin);
    users[u]={password:p,personalSecret:s,isAdmin,notes:[]};
    save();
    newCaptcha("regCaptchaText",regCap);
    showSection("login-sec");
}

function handleLogin(){
    if(+document.getElementById("loginCaptcha").value!==loginCap.ans)
        return alert("Captcha wrong");

    let u=loginUser.value.trim();
    let p=loginPass.value;
    if(!users[u]||users[u].password!==p) return alert("Invalid login");

    currentUser=u;
    localStorage.setItem("pv_user",u);
    if(users[u].isAdmin){
        if(!sys.code) generateCode();
        openVault();
    } else showSection("verify-sec");
}

function generateCode(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    sys.code="";
    for(let i=0;i<10;i++) sys.code+=chars[Math.floor(Math.random()*chars.length)];
    save(); renderAdmin();
}

function confirmFamilyCode(){
    if(verifyCode.value===sys.code) openVault();
    else alert("Wrong code");
}

function openVault(){
    showSection("vault-sec");
    welcome.innerText="Hello "+currentUser;
    mySecret.innerText=users[currentUser].personalSecret;
    if(users[currentUser].isAdmin){
        adminPanel.style.display="block";
        renderAdmin();
    }
    renderNotes();
}

function renderAdmin(){
    familyCode.innerText=sys.code;
    userList.innerHTML="";
    Object.keys(users).forEach(u=>{
        userList.innerHTML+=`${u}
        <button onclick="deleteUser('${u}')">Delete</button><br>`;
    });
}

function deleteUser(u){
    if(confirm("Delete "+u+"?")){
        delete users[u]; save(); renderAdmin();
    }
}

function addNote(){
    if(!noteTitle.value) return;
    users[currentUser].notes.push({t:noteTitle.value,c:noteContent.value,id:Date.now()});
    save(); renderNotes();
    noteTitle.value=""; noteContent.value="";
}

function renderNotes(){
    notes.innerHTML="";
    users[currentUser].notes.forEach(n=>{
        notes.innerHTML+=`<div class="note-card"><b>${n.t}</b><p>${n.c}</p></div>`;
    });
}

function logout(){
    localStorage.removeItem("pv_user");
    location.reload();
}

if(currentUser) openVault();
</script>
</body>
</html>
