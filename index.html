export default {
  async fetch(req, env) {
    const url = new URL(req.url);
    const path = url.pathname;

    if (req.method !== "POST")
      return new Response("Not allowed", { status: 405 });

    const data = await req.json();

    /* ===== REGISTER ===== */
    if (path === "/register") {
      const { username, password, familyCode } = data;
      if (!username || !password || !familyCode)
        return json({ error: "Missing fields" });

      const sys = await env.SYS.get("config", "json");
      if (!sys || sys.familyCode !== familyCode)
        return json({ error: "Invalid family code" });

      if (await env.USERS.get(username))
        return json({ error: "User exists" });

      const hash = await hashPass(password);
      const isAdmin = !(await env.USERS.get("ADMIN_EXISTS"));

      await env.USERS.put(
        username,
        JSON.stringify({ hash, isAdmin, notes: [] })
      );

      if (isAdmin) await env.USERS.put("ADMIN_EXISTS", "true");

      return json({ ok: true });
    }

    /* ===== LOGIN ===== */
    if (path === "/login") {
      const { username, password } = data;
      const user = await env.USERS.get(username, "json");
      if (!user) return json({ error: "Invalid login" });

      const hash = await hashPass(password);
      if (hash !== user.hash)
        return json({ error: "Invalid login" });

      const token = crypto.randomUUID();
      await env.USERS.put(
        `session:${token}`,
        JSON.stringify({ username, isAdmin: user.isAdmin }),
        { expirationTtl: 86400 }
      );

      return json({ token, isAdmin: user.isAdmin });
    }

    /* ===== NOTES ===== */
    if (path === "/notes") {
      const session = await auth(req, env);
      if (!session) return json({ error: "Unauthorized" });

      const user = await env.USERS.get(session.username, "json");

      if (data.add) {
        user.notes.push({ t: data.t, c: data.c });
        await env.USERS.put(session.username, JSON.stringify(user));
      }

      return json({ notes: user.notes });
    }

    return json({ error: "Unknown endpoint" });
  },
};

function json(obj) {
  return new Response(JSON.stringify(obj), {
    headers: { "Content-Type": "application/json" },
  });
}

async function auth(req, env) {
  const token = req.headers.get("Authorization");
  if (!token) return null;
  return await env.USERS.get(`session:${token}`, "json");
}

async function hashPass(p) {
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(p)
  );
  return [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}
